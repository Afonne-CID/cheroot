sudo: false
language: python
python:
- 2.6
- 2.7
- 3.3
- 3.4
- 3.5
- 3.6
- nightly
_base_envs:
- &pypy_base
  python: pypy
  env:
  - PYPY_VERSION=pypy2-5.7.1
  - PYENV_ROOT="$HOME/.pyenv"
  - PATH="$PYENV_ROOT/bin:$PATH"
  dist: trusty
  sudo: required
  addons:
    apt:
      packages:
      - make
      - build-essential
      - libssl-dev
      - zlib1g-dev
      - libbz2-dev
      - libreadline-dev
      - libsqlite3-dev
      - wget
      - curl
      - llvm
      - libncurses5-dev
      - libncursesw5-dev
      - xz-utils
      - tk-dev
  before_install:
  - &ensure_pyenv_installed |
    if [ -f "$PYENV_ROOT/bin/pyenv" ]
    then
      eval "$(pyenv init -)"
      eval "$(pyenv virtualenv-init -)"
      pyenv update
    else
      rm -rf "$PYENV_ROOT"
      curl -L https://raw.githubusercontent.com/pyenv/pyenv-installer/master/bin/pyenv-installer | bash
      eval "$(pyenv init -)"
      eval "$(pyenv virtualenv-init -)"
    fi
  - &install_python pyenv install --skip-existing --keep --verbose "$PYPY_VERSION"
  - &switch_python pyenv shell "$PYPY_VERSION"
  - &python_version python --version
- &osx_base
  <<: *pypy_base
  os: osx
  before_install:
  - brew update
  - brew install readline xz
  - *ensure_pyenv_installed
  - *install_python
  - *switch_python
  - *python_version
matrix:
  fast_finish: true
  allow_failures:
  - env: TOXENV=pre-commit-pep257
  - os: osx
  include:
  - <<: *osx_base
    language: generic
    python: pypy2-5.7.1
    env:
    - PYPY_VERSION=pypy2-5.7.1
    - PYENV_ROOT="$HOME/.pyenv"
    - PATH="$PYENV_ROOT/bin:$PATH"
  - <<: *pypy_base
    python: pypy
    env:
    - PYPY_VERSION=pypy2-5.7.1
    - PYENV_ROOT="$HOME/.pyenv"
    - PATH="$PYENV_ROOT/bin:$PATH"
  - <<: *pypy_base
    python: pypy3
    env:
    - PYPY_VERSION=pypy3.5-5.7.1-beta
    - PYENV_ROOT="$HOME/.pyenv"
    - PATH="$PYENV_ROOT/bin:$PATH"
  - python: 3.6
    env: TOXENV=pre-commit
  - python: 3.6
    env: TOXENV=pre-commit-pep257
cache:
  pip: true
  directories:
  - $HOME/.pre-commit
before_install:
- "if [[ $TRAVIS_PYTHON_VERSION == 'pypy3' ]]; then . .travis/replace-pypy3 ; fi"
install:
- pip install tox "setuptools>=28.2"
script:
- tox
branches:
  except:
  - skeleton
deploy:
  provider: pypi
  server: https://upload.pypi.org/legacy/
  on:
    tags: true
    all_branches: true
    python: 3.6
  user: jaraco
  distributions: dists
  skip_upload_docs: true
  password:
    secure: RAfz06AINvz7bfij/YhfkAreRqamgxS8a6jSRNxntYhtJke3ZszUbIDag8+n1I+G5XT2LnMhHqPNR7Plc+AeMz7VXTuy+b81Li5kse20NYlPhd7mBVmTUpXtqYQashV5J39F4qkATBLznCOrMEomM07VTXjO/o2hmQuXniab2Uo=
