---

name: pip-tools

on:   # yamllint disable-line rule:truthy
  workflow_dispatch:
  schedule:
  - cron: 1 0 * * *  # Run daily at 0:01 UTC

concurrency:
  group: >-
    ${{
        github.workflow
    }}-${{
        github.event.pull_request.number || github.sha
    }}
  cancel-in-progress: true

jobs:

  deps:
    name: >-
      ⛓🔒 🐍${{
          matrix.python-version
      }} @ ${{
          matrix.os
      }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        python-version:
        # NOTE: The latest and the lowest supported Pythons are prioritized
        # NOTE: to improve the responsiveness. It's nice to see the most
        # NOTE: important results first.
        - >-
          3.10
        - pypy2
        - 3.9
        - 3.8
        - pypy-3.7
        - 3.7
        - 3.6
        - 3.5
        - 2.7
        - 3.11.0-alpha - 3.11.0
        - pypy-3.6
        os:
        - ubuntu-18.04
        - macOS-11.0
        - windows-2016
        include:
        # NOTE: The only GNU/Linux CPython 3.4 available is built for Ubuntu 18
        # https://github.com/actions/python-versions/blob/c483657/versions-manifest.json#L1228
        - os: ubuntu-18.04
          python-version: 3.4

    env:
      PIP_DISABLE_PIP_VERSION_CHECK: 1
      PIP_NO_PYTHON_VERSION_WARNING: 1
      PIP_NO_WARN_SCRIPT_LOCATION: 1
      PY_COLORS: 1

    steps:
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v2
      with:
        python-version: ${{ matrix.python-version }}

    - name: Upgrade pip with `requires_python`
      run: >-
        python -m
        pip install
        --user
        --upgrade
        --force-reinstall
        pip-with-requires-python
    - name: Install pip-tools
      run: >-
        python -m
        pip install
        --user
        pip-tools

    - name: Grab the source from Git
      uses: actions/checkout@v2

    - name: Run the testing
      run: >
        BASE_NAME=$(
        PYTHONPATH=bin/ python -c
        'from pip_constraint_helpers import get_constraint_file_path,
        get_runtime_python_tag;
        print(get_constraint_file_path(
        "requirements/", "py", get_runtime_python_tag())[:-4]
        )
        '
        )
        #tox-py39-cp39-linux-x86_64


        ln -svf requirements/tests.in "${BASE_NAME}.in"


        python -m piptools.compile
        --allow-unsafe
        --output-file="requirements/${BASE_NAME}.txt"
        --strip-extras
        "requirements/${BASE_NAME}.in"

  check:  # This job does nothing and is only used for the branch protection
    if: always()

    needs:
    - deps

    runs-on: ubuntu-latest

    steps:
    - name: Decide whether the needed jobs succeeded or failed
      uses: re-actors/alls-green@release/v1
      with:
        jobs: ${{ toJSON(needs) }}
